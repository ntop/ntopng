<!--page container-->
<div class='container-fluid mt-3'>
    <div class='row'>
        <div class='col-md-12 col-lg-12'>
            <nav aria-label="breadcrumb">
                <ol class="breadcrumb">
                    <li class="breadcrumb-item">{{ i18n("config_scripts.config_list", {}) }}</li>
                    {# print current page on the breadcrumb #}
                    <li class="breadcrumb-item active">{{ config_list.hooks_localizated[config_list.subdir] }}</li>
                </ol>
            </nav>
            <ul class="nav nav-pills">
                {% for _, hooks_subdir in ipairs(config_list.user_scripts.listSubdirs()) do %}
        
                        <li class="nav-item">
                            <a class="nav-link {{ (hooks_subdir.id == config_list.subdir and 'active' or '') }}" href="?subdir={{hooks_subdir.id}}">
                                {{hooks_subdir.label}}
                            </a>
                        </li>
    
                {% end %}
            </ul>
            <table id="config-list" class='table w-100 table-bordered table-striped table-hover mt-3'>
                   <thead>
                        <tr>
                            <th>{{ i18n("config_scripts.config_name", {}) }}</th>
                            <th>{{ i18n("config_scripts.applied_to", {}) }}</th>
                            <th>{{ i18n("config_scripts.config_setting", {}) }}</th>
                        </tr>
                    </thead>
                    <tbody></tbody>
            </table>
        </div>
    </div>
</div>

{# include modals for config_list.lua #}

{* config_list.template_utils.gen("config_list_components/clone_modal.html") *}
{* config_list.template_utils.gen("config_list_components/rename_modal.html") *}
{* config_list.template_utils.gen("config_list_components/delete_modal.html") *}
{* config_list.template_utils.gen("config_list_components/apply_modal.html", {
    subdir = config_list.subdir
}) *}

{# include css and javascript code for the page #}

<link href="{{ ntop.getHttpPrefix() }}/datatables/datatables.min.css" rel="stylesheet">

<script type='text/javascript'>

    // hold a csrf token for apply targets
    let apply_csrf = '{{ ntop.getRandomCSRFValue() }}';
    let clone_csrf = '{{ ntop.getRandomCSRFValue() }}';
    let rename_csrf = '{{ ntop.getRandomCSRFValue() }}';

    $(document).ready(function() {

        const $config_table = $("#config-list").DataTable({
            lengthChange: false,
            stateSave: true,
            initComplete: function() {
                // clear searchbox datatable
                $(".dataTables_filter").find("input[type='search']").val('').trigger('keyup');
            },
            language: {
                paginate: {
                   previous: '&lt;',
                   next: '&gt;'
                }
            },
            ajax: {
                url: '{{ntop.getHttpPrefix()}}/lua/get_scripts_configsets.lua?script_subdir={{ config_list.subdir }}',
                type: 'GET',
                dataSrc: ''
            },
            columns: [
                {
                    data: 'name',
                    render: function(data, type, row) {
                        return `<b>${data}</b>`
                    }
                },
                {
                    data: 'targets',
                    render: function(data, type, row) {

                        // show targets as a string into display mode
                        // if there aren't ant targets then show an alert
                        if (type == "display" && data.length > 0) {
                            const flat = data.map((f) => f.label);
                            return flat.join(', ');
                        }
                        else if(type == 'display' && data.length == 0 && row.id != 0) {
                            return "<div class='text-warning'><i class='fas fa-exclamation-triangle'></i> <b>{{ i18n('warning', {}) }}</b>: {{ i18n('config_scripts.no_targets_applied', {}) }}<div>"
                        }

                        // return targets as a string
                        const flat = data.map((f) => f.label);
                        return flat.join(', ');
                    }
                },
                {
                    targets: -1,
                    width: '10%',
                    data: null,
                    className: 'text-center',
                    render: function(data, type, row) {
                        return `
                            <div class='btn-group'>
                                <a href='script_list.lua?confset_id=${data.id}&confset_name=${data.name}&subdir={{ config_list.subdir }}' title='Edit' class='btn btn-sm btn-info square-btn'><i class='fas fa-edit'></i></a>
                                <button title='Clone' data-toggle="modal" data-target="#clone-modal" class='btn btn-sm btn-secondary square-btn' type='button'><i class='fas fa-clone'></i></button>
                                {% if config_list.subdir ~= "system" then %}
                                    <button title='Applied to'
                                     data-toggle='modal' data-target='#applied-modal' ${data.name == 'Default' ? 'disabled' : ''} 
                                     class='btn btn-sm btn-secondary square-btn' 
                                     type='button'>
                                        <i class='fas fa-server'></i>
                                    </button>
                                {% end %}
                                <button title='Rename' data-toggle="modal" data-target="#rename-modal" ${data.name == 'Default' ? 'disabled' : ''} class='btn btn-sm btn-secondary square-btn' type='button'><i class='fas fa-i-cursor'></i></button>
                                <button title='Delete' data-toggle="modal" data-target="#delete-modal" ${data.name == 'Default' ? 'disabled' : ''} class='btn btn-sm btn-danger square-btn' type='button'><i class='fas fa-times'></i></button>
                            </div>
                        `;
                    }
                }
            ]

        });

        $('#config-list').on('click', 'button[data-target="#clone-modal"]', function(e) {

            const row_data = $config_table.row($(this).parent().parent()).data();
            const conf_name = `${row_data.name}`;
            const conf_id = row_data.id;

            // set title to modal
            $("#clone-name").html(`<b>${conf_name}</b>`)
            // set a placeholder for the clone input
            $("#clone-input").attr("placeholder", `i.e. ${conf_name} (Clone)`);
            $("#clone-error").hide();

            // unbind events from button and form to prevent older events attached
            $("#btn-confirm-clone").off("click");
            $("#clone-modal form").off("submit");

            $("#btn-confirm-clone").click(function(e) {

                // get the new name for the clonation
                const clonation_name = $("#clone-input").val();
                const $button = $(this);

                if (clonation_name == null || clonation_name == "" || clonation_name == undefined) {
                    $("#clone-error").text("The name cannot be empty!").show();
                    return;
                }

                // disable button until request hasn't finished
                $button.attr("disabled", "");

                $.when(
                    $.post('{{ ntop.getHttpPrefix() }}/lua/edit_scripts_configsets.lua', {
                        action: 'clone',
                        confset_id: conf_id,
                        script_subdir: '{{ config_list.subdir }}',
                        csrf: clone_csrf,
                        confset_name: clonation_name    
                    })
                )
                .then((data, status, xhr) => {
                    
                    // re-enable button
                    $button.removeAttr("disabled");
                    // if the operation was not successful then show an error
                    if (!data.success) {
                        $("#clone-error").text(data.error).show();
                        clone_csrf = data.csrf;
                        return;
                    }
                    // hide errors and clean modal
                    $("#clone-error").hide(); $("#clone-input").val("");
                    // reload table
                    $config_table.ajax.reload();
                    // hide modal
                    $("#clone-modal").modal('hide');
                    location.reload();

                });
            })

            $("#clone-modal").on("submit", "form", function (e) {
                // prevent default form submit
                e.preventDefault();
                $("#btn-confirm-clone").trigger("click");
            });

        });

        $('#config-list').on('click', 'button[data-target="#applied-modal"]', function(e) {

        const row_data = $config_table.row($(this).parent().parent()).data();
        const conf_id = row_data.id;

        {% if config_list.subdir == "flow" or config_list.subdir == "interface" then %}
                $("#applied-interfaces").val(row_data.targets.map(d => d.key.toString()))
        {% elseif config_list.subdir == "network" then %}
                $("#applied-networks").val(row_data.targets.map(d => d.key.toString()))
        {% else %}
                $("#applied-input").val(row_data.targets.map(d => d.key.toString()).join(','))
        {% end %}


        $("#apply-name").html(`<b>${row_data.name}</b>`);

        $("#applied-modal form").off("submit");

        $('#btn-confirm-apply').off('click');
        $('#btn-confirm-apply').click(function(e) {

            const $button = $(this);

            {% if config_list.subdir == "flow" or config_list.subdir == "interface" then %}
                const applied_value = $("#applied-interfaces").val().join(','); 
            {% elseif config_list.subdir == "network" then %}
                const applied_value = $("#applied-networks").val().join(',');
            {% else %}
                const applied_value = $("#applied-input").val();
            {% end %}


            // show error message if the input is empty
            if (applied_value == "" || applied_value == null || applied_value == undefined) {
                $("#apply-error").text("The targets cannot be empty!").show();
                return;
            }

            $button.attr("disabled");

            $.when(
                $.post('{{ ntop.getHttpPrefix() }}/lua/edit_scripts_configsets.lua', {
                    action: 'set_targets',
                    confset_id: conf_id,
                    confset_targets: applied_value,
                    script_subdir: '{{ config_list.subdir }}',
                    csrf: apply_csrf
                })
            )
            .then((data, status, xhr) => {

                $button.removeAttr("disabled");

                if (!data.success) {
                    apply_csrf = data.csrf;
                    $("#apply-error").text(data.error).show();
                    return;
                }

                // hide errors and clean modal
                $("#apply-error").hide(); $("#apply-input").val("");
                // reload table
                $config_table.ajax.reload();
                // hide modal
                $("#applied-modal").modal('hide');
                location.reload();

            })


        });

        $("#applied-modal").on("submit", "form", function (e) {
            
            e.preventDefault();
            $("#btn-confirm-apply").trigger("click");
        });

        });

        $('#config-list').on('click', 'button[data-target="#rename-modal"]', function(e) {

            const row_data = $config_table.row($(this).parent().parent()).data();
            const conf_id = row_data.id;

            $("#config-name").html(`<b>${row_data.name}</b>`);
            $("#rename-input").attr('placeholder', row_data.name);

            // bind rename click event
            $("#rename-modal form").off("submit");
            $("#btn-confirm-rename").off('click');

            $("#btn-confirm-rename").click(function(e) {

                const $button = $(this);
                const input_value = $("#rename-input").val();

                // show error message if the input is empty
                if (input_value == "" || input_value == null || input_value == undefined) {
                    $("#rename-error").text("The new name cannot be empty!").show();
                    return;
                }

                $button.attr("disabled");

                $.when(
                    $.post('{{ ntop.getHttpPrefix() }}/lua/edit_scripts_configsets.lua', {
                        action: 'rename',
                        confset_id: conf_id,
                        csrf: rename_csrf,
                        confset_name: input_value
                    })
                )
                .then((data, status, xhr) => {

                    $button.removeAttr("disabled");

                    if (!data.success) {
                        $("#rename-error").text(data.error).show();
                        rename_csrf = data.csrf;
                        return;
                    }

                    // hide errors and clean modal
                    $("#rename-error").hide(); $("#rename-input").val("");
                    // reload table
                    $config_table.ajax.reload();
                    // hide modal
                    $("#rename-modal").modal('hide');
                    location.reload();

                })
            })

            $("#rename-modal").on("submit", "form", function (e) {                
                e.preventDefault();
                $("#btn-confirm-rename").trigger("click");
            });

        });

        $('#config-list').on('click', 'button[data-target="#delete-modal"]', function(e) {

        const row_data = $config_table.row($(this).parent().parent()).data();
        const conf_id = row_data.id;
        $("#delete-name").html(`<b>${row_data.name}</b>`)

        $("#btn-confirm-delete").off("click");
        $("#delete-modal form").off('submit');

        $("#btn-confirm-delete").click(function(e) {

            const $button = $(this);
            $button.attr("disabled", "");

            $.when(
                $.post('{{ ntop.getHttpPrefix() }}/lua/edit_scripts_configsets.lua', {
                    action: 'delete',
                    csrf: '{{ ntop.getRandomCSRFValue() }}',
                    confset_id: conf_id,
                })
            )
            .then((data, status, xhr) => {
                
                $button.removeAttr("disabled");

                if (!data.success) {
                    $("#delete-error").text(data.error).show();
                    return;
                }

                $("#delete-error").hide(); 
                // reload table
                $config_table.ajax.reload();
                // hide modal
                $("#delete-modal").modal('hide');

                location.reload();

            });

        })

        $("#delete-modal").on("submit", "form", function (e) {
            
            e.preventDefault();
            $("#btn-confirm-delete").trigger("click");
        });

        });

    });
</script>